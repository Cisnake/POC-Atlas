apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: atlas-gitlab
  namespace: atlas-udd
  labels:
    name: atlas-gitlab
spec:
  replicas: 1
  template:
    metadata:
      name: atlas-gitlab
      labels:
        app: atlas-gitlab
    spec:
      containers:
        - image: atlas_udd/gitlab:1.0
          name: atlas-gitlab
		  env:
            - name: GITLAB_OMNIBUS_CONFIG
              value: |
                external_url 'http://atlas.gitlab'
                manage_storage_directories['manage_etc'] = false;
                gitlab_shell['auth_file'] = '/gitlab-data/ssh/authorized_keys';
                git_data_dir '/gitlab-data/git-data';
                gitlab_rails['shared_path'] = '/gitlab-data/shared';
                gitlab_rails['uploads_directory'] = '/gitlab-data/uploads';
                gitlab_ci['builds_directory'] = '/gitlab-data/builds';
          ports:
            - containerPort: 80
              name: gitlabport1
            - containerPort: 443
              name: gitlabport2
            - containerPort: 22
              name: gitlabport3            
          volumeMounts:
            - name: gitlab-config
              mountPath: /etc/gitlab
            #- name: gitlab-logs
            #  mountPath: /var/log/gitlab
            #- name: gitlab-data
            #  mountPath: /var/opt/gitlab
            - name: gitlab-data
              mountPath: /gitlab-data
      volumes:
        - name: gitlab-config
          persistentVolumeClaim:
            claimName: git-cnf-claim
        #- name: gitlab-logs
        #  persistentVolumeClaim:
        #  claimName: gitlab-log-claim
        - name: gitlab-data
          persistentVolumeClaim:
            claimName: git-data-claim
